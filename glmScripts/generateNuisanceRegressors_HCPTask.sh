#!/bin/bash

# Taku Ito
# 05/12/2017
# Generate nuisance regressors for HCP data

subjNums="100307 103111 106016 113619 117122 122317 125525 128632 131722 136833 146432 149539 153025 161731 188347 198451 211720 245333 414229 756055 100408 103414 108828 113922 118528 122620 126325 129028 133019 138534 147737 149741 154734 162733 189450 199655 212318 280739 499566 792564 101107 103818 110411 114419 118730 123117 127630 130013 133928 139637 148335 151223 156637 163129 190031 201111 214423 298051 654754 856766 101309 105014 111312 115320 118932 123925 127933 130316 135225 140925 148840 151526 159340 176542 192540 208226 221319 366446 672756 857263 101915 105115 111716 116524 120111 124422 128127 131217 135932 144832 149337 151627 160123 178950 196750 211417 239944 397760 751348 899885"

### New subjects for QC'd 352 HCP subjs
subjNums="100206 108020 117930 126325 133928 143224 153934 164636 174437 183034 194443 204521 212823 268749 322224 385450 463040 529953 587664 656253 731140 814548 877269 978578 100408 108222 118124 126426 134021 144832 154229 164939 175338 185139 194645 204622 213017 268850 329844 389357 467351 530635 588565 657659 737960 816653 878877 987074 101006 110007 118225 127933 134324 146331 154532 165638 175742 185341 195445 205119 213421 274542 341834 393247 479762 545345 597869 664757 742549 820745 887373 989987 102311 111009 118831 128632 135528 146432 154936 167036 176441 186141 196144 205725 213522 285345 342129 394956 480141 552241 598568 671855 744553 826454 896879 990366 102513 112516 118932 129028 135629 146533 156031 167440 176845 187850 196346 205826 214423 285446 348545 395756 481042 553344 599671 675661 749058 832651 899885 991267 102614 112920 119126 129129 135932 147636 157336 168745 177645 188145 198350 208226 214726 286347 349244 406432 486759 555651 604537 679568 749361 835657 901442 992774 103111 113316 120212 130013 136227 148133 157437 169545 178748 188549 198451 208327 217429 290136 352738 414229 497865 559457 615744 679770 753150 837560 907656 993675 103414 113619 120414 130114 136833 150726 157942 171330 178950 189450 199453 209228 220721 298455 356948 419239 499566 561444 618952 680452 757764 841349 908860 103818 113922 121618 130619 137229 151829 158035 171633 179346 190031 200008 210112 221319 299154 361234 424939 500222 570243 622236 687163 769064 845458 911849 104416 114217 122317 130720 137532 151930 159744 172029 180230 191235 200614 211316 228434 300618 361941 432332 513130 571144 623844 692964 773257 857263 926862 105014 114419 122822 130821 137633 152427 160123 172938 180432 192035 200917 211417 239944 303119 365343 436239 513736 579665 638049 702133 774663 865363 930449 106521 114823 123521 130922 137936 152831 160729 173334 180533 192136 201111 211619 249947 305830 366042 436845 516742 580650 645450 715041 782561 871762 942658 106824 117021 123925 131823 138332 153025 162026 173536 180735 192439 201414 211821 251833 310621 371843 445543 519950 580751 647858 720337 800941 871964 955465 107018 117122 125222 132017 138837 153227 162329 173637 180937 193239 201818 211922 257542 314225 378857 454140 523032 585862 654350 725751 803240 872562 959574 107422 117324 125424 133827 142828 153631 164030 173940 182739 194140 202719 212015 257845 316633 381543 459453 525541 586460 654754 727553 812746 873968 966975"


for subj in $subjNums
do
    #maskdir=/projects/ActFlowModel/data/${subj}/masks/
    maskdir=/projects3/NetworkDiversity/data/hcppreprocessedmsmall/${subj}/masks/
    outdir=/projects3/NetworkDiversity/data/hcppreprocessedmsmall/${subj}/nuisanceRegsTasks/
    mkdir $outdir

    echo "Extracting nuisance regressors for subject ${subj}"

    runs="tfMRI_EMOTION tfMRI_GAMBLING tfMRI_LANGUAGE tfMRI_MOTOR tfMRI_RELATIONAL tfMRI_SOCIAL tfMRI_WM"
    for run in $runs 
    do
        echo "Extracting time series for subject ${subj} and task ${run}"
        datafile_rl=/projects3/ExternalDatasets2/HCPData2/HCPS1200MSMAll/${subj}/MNINonLinear/Results/${run}_RL/${run}_RL.nii.gz
        datafile_lr=/projects3/ExternalDatasets2/HCPData2/HCPS1200MSMAll/${subj}/MNINonLinear/Results/${run}_LR/${run}_LR.nii.gz

        # Run all for RL (in parallel)
        3dmaskave -q -mask ${maskdir}/${subj}_ventricles_func.nii.gz $datafile_rl -mean > ${outdir}/${subj}_ventricles_timeseries_${run}_RL.1D &
        3dmaskave -q -mask ${maskdir}/${subj}_wmMask_func.nii.gz $datafile_rl -mean > ${outdir}/${subj}_WM_timeseries_${run}_RL.1D &
        3dmaskave -q -mask ${maskdir}/${subj}_wholebrainmask_func.nii.gz $datafile_rl -mean > ${outdir}/${subj}_wholebrain_timeseries_${run}_RL.1D &
        # Now run for LR (in parallel too)
        3dmaskave -q -mask ${maskdir}/${subj}_ventricles_func.nii.gz $datafile_lr -mean > ${outdir}/${subj}_ventricles_timeseries_${run}_LR.1D &
        3dmaskave -q -mask ${maskdir}/${subj}_wmMask_func.nii.gz $datafile_lr -mean > ${outdir}/${subj}_WM_timeseries_${run}_LR.1D &
        3dmaskave -q -mask ${maskdir}/${subj}_wholebrainmask_func.nii.gz $datafile_lr -mean > ${outdir}/${subj}_wholebrain_timeseries_${run}_LR.1D &
        wait
        # Wait until all processes finish before going to next task
    done

done
